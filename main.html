<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>GPT 음성 질문</title>
    <style>
        #record-btn,
        #hello-btn,
        #gpt-btn {
            font-size: 1.2em;
            padding: 10px 20px;
            margin-right: 10px;
        }

        #status {
            margin-top: 10px;
        }

        #transcript,
        #gpt-response {
            margin-top: 20px;
            white-space: pre-line;
            font-size: 1.2em;
            border: 1px solid #ddd;
            padding: 10px;
            min-height: 50px;
        }
    </style>
</head>

<body>
    <button id="record-btn">🎤 녹음 시작</button>
    <button id="hello-btn">🔊 "안녕하세요" 듣기</button>
    <button id="gpt-btn">🤖 GPT에게 질문(녹음)</button>
    <div id="status"></div>
    <div id="transcript"></div>
    <div id="gpt-response"></div>
    <script>
        let isRecording = false;
        let recognition = null;
        let transcriptAll = '';
        let gptQuestionMode = false;

        const btn = document.getElementById('record-btn');
        const helloBtn = document.getElementById('hello-btn');
        const gptBtn = document.getElementById('gpt-btn');
        const statusDiv = document.getElementById('status');
        const transcriptDiv = document.getElementById('transcript');
        const gptResponseDiv = document.getElementById('gpt-response');

        // 브라우저 음성인식 지원 확인
        window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!window.SpeechRecognition) {
            statusDiv.textContent = '이 브라우저는 음성 인식을 지원하지 않습니다.';
            btn.disabled = true;
            gptBtn.disabled = true;
        } else {
            recognition = new window.SpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.interimResults = false; // 실시간 X, 최종 결과만
            recognition.continuous = true;

            recognition.onstart = () => {
                statusDiv.textContent = '🎤 녹음 중...';
                transcriptAll = '';
                transcriptDiv.textContent = '';
                if (gptQuestionMode) gptResponseDiv.textContent = '';
            };
            recognition.onresult = (event) => {
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    transcriptAll += event.results[i][0].transcript + '\n';
                }
            };
            recognition.onerror = (event) => {
                statusDiv.textContent = '오류: ' + event.error;
            };
            recognition.onend = () => {
                statusDiv.textContent = '⏹️ 녹음 종료';
                btn.textContent = '🎤 녹음 시작';
                gptBtn.textContent = '🤖 GPT에게 질문(녹음)';
                isRecording = false;
                if (!gptQuestionMode) {
                    transcriptDiv.textContent = transcriptAll.trim();
                } else {
                    // GPT 질문용 코드
                    const userSpeech = transcriptAll.trim();
                    transcriptDiv.textContent = '[GPT에게 질문] ' + userSpeech;

                    // fetch 주소를 꼭 명확하게!
                    fetch('http://localhost:3000/askgpt', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question: userSpeech })
                    })
                        .then(r => r.json())
                        .then(data => {
                            gptResponseDiv.textContent = '[GPT 답변]\n' + (data.answer || '응답이 없습니다.');
                        })
                        .catch(err => {
                            gptResponseDiv.textContent = '[에러] ' + err;
                        });

                    gptQuestionMode = false;
                }
            };

            btn.onclick = function () {
                if (!isRecording) {
                    recognition.start();
                    isRecording = true;
                    btn.textContent = '⏹️ 녹음 중지';
                } else {
                    recognition.stop();
                }
            };
            gptBtn.onclick = function () {
                if (!isRecording) {
                    gptQuestionMode = true;
                    recognition.start();
                    isRecording = true;
                    gptBtn.textContent = '⏹️ 녹음 중지(GPT)';
                } else {
                    recognition.stop();
                }
            };
        }

        // "안녕하세요" TTS(음성합성) 버튼
        helloBtn.onclick = function () {
            const msg = new SpeechSynthesisUtterance("안녕하세요");
            msg.lang = 'ko-KR';
            window.speechSynthesis.speak(msg);
        };
    </script>
</body>

</html>