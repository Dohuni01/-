<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>GPT ìŒì„± ì§ˆë¬¸</title>
    <style>
        #record-btn,
        #hello-btn,
        #gpt-btn {
            font-size: 1.2em;
            padding: 10px 20px;
            margin-right: 10px;
        }

        #status {
            margin-top: 10px;
        }

        #transcript,
        #gpt-response {
            margin-top: 20px;
            white-space: pre-line;
            font-size: 1.2em;
            border: 1px solid #ddd;
            padding: 10px;
            min-height: 50px;
        }
    </style>
</head>

<body>
    <button id="record-btn">ğŸ¤ ë…¹ìŒ ì‹œì‘</button>
    <button id="hello-btn">ğŸ”Š "ì•ˆë…•í•˜ì„¸ìš”" ë“£ê¸°</button>
    <button id="gpt-btn">ğŸ¤– GPTì—ê²Œ ì§ˆë¬¸(ë…¹ìŒ)</button>
    <div id="status"></div>
    <div id="transcript"></div>
    <div id="gpt-response"></div>
    <script>
        let isRecording = false;
        let recognition = null;
        let transcriptAll = '';
        let gptQuestionMode = false;

        const btn = document.getElementById('record-btn');
        const helloBtn = document.getElementById('hello-btn');
        const gptBtn = document.getElementById('gpt-btn');
        const statusDiv = document.getElementById('status');
        const transcriptDiv = document.getElementById('transcript');
        const gptResponseDiv = document.getElementById('gpt-response');

        // ë¸Œë¼ìš°ì € ìŒì„±ì¸ì‹ ì§€ì› í™•ì¸
        window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!window.SpeechRecognition) {
            statusDiv.textContent = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
            btn.disabled = true;
            gptBtn.disabled = true;
        } else {
            recognition = new window.SpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.interimResults = false; // ì‹¤ì‹œê°„ X, ìµœì¢… ê²°ê³¼ë§Œ
            recognition.continuous = true;

            recognition.onstart = () => {
                statusDiv.textContent = 'ğŸ¤ ë…¹ìŒ ì¤‘...';
                transcriptAll = '';
                transcriptDiv.textContent = '';
                if (gptQuestionMode) gptResponseDiv.textContent = '';
            };
            recognition.onresult = (event) => {
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    transcriptAll += event.results[i][0].transcript + '\n';
                }
            };
            recognition.onerror = (event) => {
                statusDiv.textContent = 'ì˜¤ë¥˜: ' + event.error;
            };
            recognition.onend = () => {
                statusDiv.textContent = 'â¹ï¸ ë…¹ìŒ ì¢…ë£Œ';
                btn.textContent = 'ğŸ¤ ë…¹ìŒ ì‹œì‘';
                gptBtn.textContent = 'ğŸ¤– GPTì—ê²Œ ì§ˆë¬¸(ë…¹ìŒ)';
                isRecording = false;
                if (!gptQuestionMode) {
                    transcriptDiv.textContent = transcriptAll.trim();
                } else {
                    // GPT ì§ˆë¬¸ìš© ì½”ë“œ
                    const userSpeech = transcriptAll.trim();
                    transcriptDiv.textContent = '[GPTì—ê²Œ ì§ˆë¬¸] ' + userSpeech;

                    // fetch ì£¼ì†Œë¥¼ ê¼­ ëª…í™•í•˜ê²Œ!
                    fetch('http://localhost:3000/askgpt', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question: userSpeech })
                    })
                        .then(r => r.json())
                        .then(data => {
                            gptResponseDiv.textContent = '[GPT ë‹µë³€]\n' + (data.answer || 'ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.');
                        })
                        .catch(err => {
                            gptResponseDiv.textContent = '[ì—ëŸ¬] ' + err;
                        });

                    gptQuestionMode = false;
                }
            };

            btn.onclick = function () {
                if (!isRecording) {
                    recognition.start();
                    isRecording = true;
                    btn.textContent = 'â¹ï¸ ë…¹ìŒ ì¤‘ì§€';
                } else {
                    recognition.stop();
                }
            };
            gptBtn.onclick = function () {
                if (!isRecording) {
                    gptQuestionMode = true;
                    recognition.start();
                    isRecording = true;
                    gptBtn.textContent = 'â¹ï¸ ë…¹ìŒ ì¤‘ì§€(GPT)';
                } else {
                    recognition.stop();
                }
            };
        }

        // "ì•ˆë…•í•˜ì„¸ìš”" TTS(ìŒì„±í•©ì„±) ë²„íŠ¼
        helloBtn.onclick = function () {
            const msg = new SpeechSynthesisUtterance("ì•ˆë…•í•˜ì„¸ìš”");
            msg.lang = 'ko-KR';
            window.speechSynthesis.speak(msg);
        };
    </script>
</body>

</html>